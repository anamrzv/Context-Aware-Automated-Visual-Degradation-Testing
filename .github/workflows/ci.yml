name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  playwright-visual:
    name: Playwright Visual Tests
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.48.0-jammy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Start logging
        run: echo "[$(date)] [TEST] Starting Playwright tests..." > test.log
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Build project
        run: npm run build
      
      - name: Start preview server
        run: |
          npm run preview &
          sleep 5
      
      - name: Run Playwright tests
        run: npx playwright test || true
      
      - name: Check for visual changes
        run: |
          if [ -f diff_detected.txt ]; then
            echo "[$(date)] [TEST] Visual changes detected!" >> test.log
          else
            echo "[$(date)] [TEST] No visual changes found." >> test.log
          fi
      
      - name: Finish logging
        run: echo "[$(date)] [TEST] Tests finished." >> test.log
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            test-artifacts/
            tests/baselines/
            playwright-report/
            diff_detected.txt
            test.log
          retention-days: 2

  ai-analysis:
    name: AI Analysis
    runs-on: ubuntu-latest
    needs: playwright-visual
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-artifacts
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Start logging
        run: echo "[$(date)] [AI-ANALYSIS] Installing dependencies..." > ai.log
      
      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install requests pillow
      
      - name: Run AI analysis script
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
        run: |
          echo "[$(date)] [AI-ANALYSIS] Starting AI analysis script..." >> ai.log
          python3 scripts/check_diff.py
          echo "[$(date)] [AI-ANALYSIS] Script finished." >> ai.log
      
      - name: Upload AI analysis artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis
          path: |
            ai-report.json
            ai.log
          retention-days: 2

  generate-report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [ ai-analysis, playwright-visual ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-artifacts
      
      - name: Download AI analysis artifacts
        uses: actions/download-artifact@v4
        with:
          name: ai-analysis
        continue-on-error: true
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Create pipeline log
        run: |
          cat test.log > pipeline.log
          if [ -f ai.log ]; then cat ai.log >> pipeline.log; fi
          echo "[$(date)] [REPORT] Generating HTML report..." >> pipeline.log
      
      - name: Run report generation script
        run: |
          python3 scripts/generate_report.py
          echo "[$(date)] [REPORT] Process complete." >> pipeline.log
      
      - name: Upload final report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-report
          path: |
            visual_report.html
            test-artifacts/
            tests/baselines/
            pipeline.log
          retention-days: 7

  upload-report:
    name: Upload Report to Pages
    runs-on: ubuntu-latest
    needs: generate-report
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'))
    
    steps:
      - name: Download report artifacts
        uses: actions/download-artifact@v4
        with:
          name: visual-report
          path: ./report
      
      - name: Create index.html for GitHub Pages
        run: |
          if [ -f ./report/visual_report.html ]; then
            cp ./report/visual_report.html ./report/index.html
          fi
      
      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './report'

  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: upload-report
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
